#!/bin/bash

usage() {
    echo "usage: install -r RELEASE TARBALL [...installer opts..]" >&2
    exit 1
}

args="$(getopt -o +r: --long help,release: -- "$@")"
eval "set -- $args"
while true; do
    case "$1" in
        --help) usage;;
        -r|--release) RELEASE="$2"; shift; shift;;
        --) shift; break;;
        *) usage;;
    esac
done
INSTALLER="$1"; shift
INSTALLER_ARGS=("$@"); set --

if [ -z "$RELEASE" ] || [ -z "$INSTALLER" ]; then
    usage
fi

if [ "$EUID" -ne 0 ]; then
    echo "error: this script must be run as root" >&2
    exit 1
fi

set -ex

THIS_DIR="$(dirname "$(readlink -f "$0")")"

BASE_CONTAINER_NAME=zulip-install-"$RELEASE"-base
if ! lxc-info -n "$BASE_CONTAINER_NAME" >/dev/null 2>&1; then
    "$THIS_DIR"/prepare-base "$RELEASE"
fi

while [ -z "$CONTAINER_NAME" ] || lxc-info -n "$CONTAINER_NAME" >/dev/null 2>&1; do
    CONTAINER_NAME="$(mktemp -u zulip-install-"$RELEASE"-XXXXX)"
done

lxc-copy --ephemeral --keepdata -n "$BASE_CONTAINER_NAME" -N "$CONTAINER_NAME"

run() {
    lxc-attach -n "$CONTAINER_NAME" -- "$@"
}

# Wait for the container to boot, polling.
ok=
for i in {1..60}; do
    runlevel="$(run runlevel 2>/dev/null)" || { sleep 1; continue; }
    if [ "$runlevel" != "${0%[0-9]}" ]; then
        ok=1
        break
    fi
    sleep 1
done
if [ -z "ok" ]; then
    echo "error: timeout waiting for container to boot" >&2
    exit 1
fi

# TODO kill this with an installer flag
run apt-get install -y openssl ssl-cert
run ln -nsf /etc/ssl/certs/ssl-cert-snakeoil.pem /etc/ssl/certs/zulip.combined-chain.crt
run ln -nsf /etc/ssl/private/ssl-cert-snakeoil.key /etc/ssl/private/zulip.key

# TODO make this a proper dep -- else
# /tmp/zulip-server-1.7.1/scripts/lib/../../scripts/lib/third/install-yarn.sh: line 43: curl: command not found
run apt-get install -y curl

<"$INSTALLER" run dd of=/tmp/zulip-server.tar.gz
run tar -xf /tmp/zulip-server.tar.gz -C /tmp/
installer_path=$(run sh -c 'echo /tmp/zulip-server-*/scripts/setup/install')
run "$installer_path" "${INSTALLER_ARGS[@]}"
# TODO install ends as a zombie (workaround: `sudo ps aux | grep lxc-attach`, kill that)

# TODO settings.py, initialize-database, create realm

# TODO eatmydata, for speed
