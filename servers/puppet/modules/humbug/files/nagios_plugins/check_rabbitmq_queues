#!/usr/bin/env python

"""
Nagios plugin to check that the rabbitmq queues are not overflowing as a result
of a stuck consumer

This script just checks the contents of /var/run/nagios/check-rabbitmq-results,
which is generated by bots/check-rabbitmq-queue.py

* * * * * /home/humbug/bots/check-rabbitmq-queue &> /var/run/nagios/check-rabbitmq-results
"""

import os
import time

RESULTS_FILE = "/var/run/nagios/check-rabbitmq-results"

data = file(RESULTS_FILE).read().strip()
pieces = data.split('|')

if not len(pieces) == 4:
    state = 'UNKNOWN'
    ret = 3
    data = "Results file malformed"
else:
    timestamp = int(pieces[0])

    time_diff = time.time() - timestamp
    if time_diff > 60 * 2:
        ret = 3
        state = 'UNKNOWN'
        data = "Results file is stale"
    else:
        ret = int(pieces[1])
        state = pieces[2]
        data = pieces[3]

print "%s: %s" % (state, data)

exit(ret)
